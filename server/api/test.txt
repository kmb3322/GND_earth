const fs = require('fs');
const path = require('path');

const addHyphenToCode = (code) => {
  return code.replace(/(\d{4})(?=\d)/g, '$1-');
};

module.exports = async (req, res) => {
  if (req.method === 'POST' && req.url === '/api/validate-code') {
    const { code } = req.body;
    const databasePath = path.join(__dirname, '../database.json');
    const database = JSON.parse(fs.readFileSync(databasePath, 'utf-8'));

    const codeEntry = database.find((entry) => entry.code === code && entry.isempty === 1);

    if (codeEntry) {
      res.status(200).json({ valid: true });
    } else {
      res.status(400).json({
        valid: false,
        message: '입력하신 코드는 사용할 수 없습니다. 또는 이미 사용된 코드입니다.',
      });
    }
  }

  if (req.method === 'POST' && req.url === '/api/submit-contact') {
    const { name, phone, code } = req.body;
    const formattedCode = addHyphenToCode(code);

    console.log('Received data:', req.body);

    if (!name || !phone || !code) {
      return res.status(400).json({ success: false, message: '모든 필드를 채워주세요.' });
    }

    const databasePath = path.join(__dirname, '../database.json');
    try {
      const data = fs.readFileSync(databasePath, 'utf8');
      const database = JSON.parse(data);

      const codeEntry = database.find((entry) => entry.code === formattedCode);

      if (!codeEntry) {
        return res.status(400).json({ success: false, message: '유효하지 않은 코드입니다.' });
      }

      codeEntry.name = name;
      codeEntry.phone = phone;
      codeEntry.isempty = 0;

      fs.writeFileSync(databasePath, JSON.stringify(database, null, 2), 'utf8');

      return res.status(200).json({ success: true, message: '연락처가 성공적으로 저장되었습니다.' });
    } catch (err) {
      return res.status(500).json({ success: false, message: '서버 오류가 발생했습니다.' });
    }
  }
};
